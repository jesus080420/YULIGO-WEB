<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yuligo Web</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .chat-container { height: calc(100vh - 160px); }
        body { background-color: #f3f4f6; }
    </style>
</head>
<body class="flex flex-col h-screen font-sans">

    <header class="bg-blue-600 text-white p-4 shadow-md text-center font-bold text-xl">
        Yuligo AI
    </header>

    <div id="chat-box" class="chat-container overflow-y-auto p-4 flex flex-col gap-3">
        </div>

    <div id="loading" class="hidden text-center text-sm text-gray-500 mb-2">Yuligo est√° pensando...</div>

    <div class="p-4 bg-white border-t flex flex-col gap-2">
        <div id="preview-container" class="hidden flex items-center gap-2">
            <span class="text-xs bg-gray-200 p-1 rounded">Imagen seleccionada</span>
            <button onclick="clearImage()" class="text-red-500 text-xs font-bold">X</button>
        </div>
        
        <div class="flex items-center gap-2">
            <label class="cursor-pointer bg-gray-100 p-2 rounded-full hover:bg-gray-200">
                üì∑
                <input type="file" id="image-input" accept="image/*" class="hidden" onchange="handleImage(event)">
            </label>
            <input type="text" id="user-input" placeholder="Habla con Yuligo..." class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
            <button onclick="sendMessage()" class="bg-blue-600 text-white p-2 rounded-full w-10 h-10 flex items-center justify-center">
                ‚úàÔ∏è
            </button>
        </div>
    </div>

    <script>
        const API_KEY = "AIzaSyCEXdHVKEKAw3-d1tnd3c31-IwkWBBtA7U"; // Tu clave Gemini
        let selectedImageBase64 = null;

        // Cargar historial al iniciar
        window.onload = () => {
            const history = JSON.parse(localStorage.getItem('yuligo_memory') || '[]');
            history.forEach(msg => appendMessage(msg.text, msg.isUser));
        };

        function handleImage(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (event) => {
                selectedImageBase64 = event.target.result.split(',')[1];
                document.getElementById('preview-container').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function clearImage() {
            selectedImageBase64 = null;
            document.getElementById('image-input').value = '';
            document.getElementById('preview-container').classList.add('hidden');
        }

        async function sendMessage() {
            const inputField = document.getElementById('user-input');
            const text = inputField.value.trim();
            if (!text && !selectedImageBase64) return;

            appendMessage(text, true);
            inputField.value = '';
            showLoading(true);

            const payload = {
                contents: [{
                    parts: [
                        { text: `Tu nombre es Yuligo. Eres un amigo IA c√°lido. Responde breve (m√°ximo 2 frases) a: ${text}` }
                    ]
                }]
            };

            if (selectedImageBase64) {
                payload.contents[0].parts.push({
                    inline_data: { mime_type: "image/jpeg", data: selectedImageBase64 }
                });
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                const aiResponse = data.candidates[0].content.parts[0].text;
                
                appendMessage(aiResponse, false);
                speak(aiResponse);
                saveHistory(text, aiResponse);
            } catch (error) {
                console.error("Error:", error);
                appendMessage("Lo siento, tuve un problema al conectarme.", false);
            } finally {
                showLoading(false);
                clearImage();
            }
        }

        function appendMessage(text, isUser) {
            const chatBox = document.getElementById('chat-box');
            const msgDiv = document.createElement('div');
            msgDiv.className = `max-w-[80%] p-3 rounded-2xl ${isUser ? 'bg-blue-600 text-white self-end' : 'bg-gray-300 text-black self-start'}`;
            msgDiv.innerText = text;
            chatBox.appendChild(msgDiv);
            chatBox.scrollTop = chatBox.scrollHeight;
        }

        function speak(text) {
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-MX';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('hidden', !show);
        }

        function saveHistory(userTxt, aiTxt) {
            let history = JSON.parse(localStorage.getItem('yuligo_memory') || '[]');
            history.push({text: userTxt, isUser: true}, {text: aiTxt, isUser: false});
            localStorage.setItem('yuligo_memory', JSON.stringify(history.slice(-20)));
        }
    </script>
</body>
</html>
